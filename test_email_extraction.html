<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Email Extraction for PDF Footer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #17394B;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .result {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
        .error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
        button {
            background-color: #17394B;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0f2a3a;
        }
        .email-source {
            font-weight: bold;
            color: #17394B;
        }
        .footer-preview {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Email Extraction for PDF Footer</h1>
        
        <div class="test-section">
            <h3>Current localStorage Data</h3>
            <button onclick="checkCurrentData()">Check Current Data</button>
            <div id="currentData"></div>
        </div>
        
        <div class="test-section">
            <h3>Test Email Extraction Logic</h3>
            <button onclick="testEmailExtraction()">Test Email Extraction</button>
            <div id="emailResults"></div>
        </div>
        
        <div class="test-section">
            <h3>Add Test Data</h3>
            <button onclick="addTestData()">Add Test User Data</button>
            <button onclick="addSupabaseAuthData()">Add Supabase Auth Data</button>
            <button onclick="clearTestData()">Clear All Test Data</button>
        </div>
        
        <div class="test-section">
            <h3>Footer Preview</h3>
            <button onclick="generateFooterPreview()">Generate Footer Preview</button>
            <div id="footerPreview"></div>
        </div>
    </div>

    <script>
        function checkCurrentData() {
            const container = document.getElementById('currentData');
            container.innerHTML = '<h4>Checking localStorage keys...</h4>';
            
            const keys = [
                'userEmail',
                'authUser',
                'supabase.auth.token',
                'personalContactData',
                'personalInfo',
                'basicInfo',
                'userData',
                'formData'
            ];
            
            let html = '';
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        html += `<div class="result"><span class="email-source">${key}:</span> ${JSON.stringify(parsed, null, 2)}</div>`;
                    } catch (e) {
                        html += `<div class="result"><span class="email-source">${key}:</span> ${data}</div>`;
                    }
                } else {
                    html += `<div class="result error"><span class="email-source">${key}:</span> Not found</div>`;
                }
            });
            
            container.innerHTML = html;
        }
        
        function testEmailExtraction() {
            const container = document.getElementById('emailResults');
            container.innerHTML = '<h4>Testing email extraction...</h4>';
            
            // Simulate the email extraction logic from the PDF generator
            let userName = '';
            let userEmail = '';
            
            try {
                // Try multiple possible localStorage keys for user data
                const possibleKeys = [
                    'personalContactData',
                    'personalInfo',
                    'basicInfo',
                    'userData',
                    'formData'
                ];
                
                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed.firstName && parsed.lastName) {
                                userName = `${parsed.firstName} ${parsed.lastName}`;
                                break;
                            }
                        } catch (e) {
                            continue;
                        }
                    }
                }
                
                // Get user email from multiple possible sources
                const emailSources = [
                    localStorage.getItem('userEmail'),
                    JSON.parse(localStorage.getItem('authUser') || '{}')?.email,
                    JSON.parse(localStorage.getItem('supabase.auth.token') || '{}')?.currentSession?.user?.email,
                    JSON.parse(localStorage.getItem('supabase.auth.token') || '{}')?.access_token ? 
                        JSON.parse(atob(JSON.parse(localStorage.getItem('supabase.auth.token') || '{}')?.access_token.split('.')[1]))?.email : null
                ];
                
                let emailFound = false;
                emailSources.forEach((email, index) => {
                    if (email && typeof email === 'string' && email.includes('@')) {
                        userEmail = email;
                        emailFound = true;
                        container.innerHTML += `<div class="result">✅ Email found from source ${index + 1}: <strong>${email}</strong></div>`;
                    }
                });
                
                // If still no valid email found, try to get from form data
                if (!emailFound) {
                    for (const key of possibleKeys) {
                        const data = localStorage.getItem(key);
                        if (data) {
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.email && parsed.email.includes('@')) {
                                    userEmail = parsed.email;
                                    emailFound = true;
                                    container.innerHTML += `<div class="result">✅ Email found from form data (${key}): <strong>${parsed.email}</strong></div>`;
                                    break;
                                }
                            } catch (e) {
                                continue;
                            }
                        }
                    }
                }
                
                // If no name found, use email prefix as name
                if (!userName && userEmail && userEmail.includes('@')) {
                    userName = userEmail.split('@')[0];
                }
                
                if (!emailFound) {
                    userEmail = 'No email available';
                    container.innerHTML += `<div class="result error">❌ No valid email found in any source</div>`;
                }
                
                if (!userName) {
                    userName = 'User';
                }
                
                container.innerHTML += `<div class="result"><strong>Final Results:</strong></div>`;
                container.innerHTML += `<div class="result">Name: <strong>${userName}</strong></div>`;
                container.innerHTML += `<div class="result">Email: <strong>${userEmail}</strong></div>`;
                
            } catch (e) {
                userName = 'User';
                userEmail = 'No email available';
                container.innerHTML += `<div class="result error">❌ Error during extraction: ${e.message}</div>`;
            }
        }
        
        function addTestData() {
            localStorage.setItem('personalContactData', JSON.stringify({
                firstName: 'John',
                lastName: 'Doe',
                email: 'john.doe@example.com'
            }));
            
            localStorage.setItem('userEmail', 'john.doe@example.com');
            
            document.getElementById('emailResults').innerHTML = '<div class="result">✅ Test data added: John Doe (john.doe@example.com)</div>';
        }
        
        function addSupabaseAuthData() {
            // Simulate Supabase auth token structure
            const mockToken = {
                currentSession: {
                    user: {
                        email: 'samantha.mcmahon@skillbinder.com'
                    }
                }
            };
            
            localStorage.setItem('supabase.auth.token', JSON.stringify(mockToken));
            
            document.getElementById('emailResults').innerHTML = '<div class="result">✅ Supabase auth data added: samantha.mcmahon@skillbinder.com</div>';
        }
        
        function clearTestData() {
            const keys = [
                'userEmail',
                'authUser',
                'supabase.auth.token',
                'personalContactData',
                'personalInfo',
                'basicInfo',
                'userData',
                'formData'
            ];
            
            keys.forEach(key => localStorage.removeItem(key));
            
            document.getElementById('emailResults').innerHTML = '<div class="result">✅ All test data cleared</div>';
        }
        
        function generateFooterPreview() {
            const container = document.getElementById('footerPreview');
            
            // Get current date and time
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const timezone = now.toLocaleTimeString('en-US', { 
                timeZoneName: 'short' 
            }).split(' ').pop() || 'EDT';
            
            // Extract user data (simplified version)
            let userName = 'User';
            let userEmail = 'No email available';
            
            try {
                // Try to get name and email
                const personalData = localStorage.getItem('personalContactData');
                if (personalData) {
                    const parsed = JSON.parse(personalData);
                    if (parsed.firstName && parsed.lastName) {
                        userName = `${parsed.firstName} ${parsed.lastName}`;
                    }
                    if (parsed.email) {
                        userEmail = parsed.email;
                    }
                }
                
                // Try other email sources
                if (userEmail === 'No email available') {
                    const email = localStorage.getItem('userEmail');
                    if (email) userEmail = email;
                }
                
                if (userEmail === 'No email available') {
                    const authUser = localStorage.getItem('authUser');
                    if (authUser) {
                        const parsed = JSON.parse(authUser);
                        if (parsed.email) userEmail = parsed.email;
                    }
                }
                
                if (userEmail === 'No email available') {
                    const supabaseToken = localStorage.getItem('supabase.auth.token');
                    if (supabaseToken) {
                        const parsed = JSON.parse(supabaseToken);
                        if (parsed.currentSession?.user?.email) {
                            userEmail = parsed.currentSession.user.email;
                        }
                    }
                }
                
            } catch (e) {
                console.error('Error generating footer preview:', e);
            }
            
            const footerText = `Generated for: ${userName} | Email: ${userEmail} | Generated on: ${dateStr} @ ${timeStr} hrs ${timezone}`;
            
            container.innerHTML = `
                <div class="footer-preview">
                    <strong>Footer Preview:</strong><br>
                    ${footerText}
                </div>
            `;
        }
        
        // Auto-run on page load
        window.onload = function() {
            checkCurrentData();
        };
    </script>
</body>
</html>
